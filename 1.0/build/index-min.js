/*!build time : 2014-07-23 4:03:54 PM*/
KISSY.add("gallery/wScratchPad/1.0/index",function(a,b,c,d){"use strict";function e(a){var b=this;return a.srcNode==f?(alert("\u6e32\u67d3\u8282\u70b9\u4e0d\u80fd\u4e3a\u7a7a"),!0):void e.superclass.constructor.call(b,a)}var f="",g=b.all,h=d.Gesture;return a.extend(e,c,{initializer:function(){var a=this;return a.options=a.getAttrVals(),a.$el=a.get("srcNode"),a._supportCanvas()?(a.$el.html("Canvas is not supported in this browser."),!0):(a.enabled=!0,a.canvas=document.createElement("canvas"),a.ctx=a.canvas.getContext("2d"),"static"===a.$el.css("position")&&a.$el.css("position","relative"),a.$img=g('<img src=""/>'),a.options.bgOrigin&&a.$img.attr("crossOrigin","*"),a.$img.css(a.options.bgSize?{position:"absolute",width:a.options.bgSize.width,height:a.options.bgSize.height}:{position:"absolute",width:"100%",height:"100%"}),a.$scratchpad=g(a.canvas).css({position:"absolute",width:"100%",height:"100%"}),a.$el.append(a.$img).append(a.$scratchpad),a.render(),a._addEvent(),void a._bindEvents())},_addEvent:function(){var a=this;a.on("destroy",function(){a.$el.children().remove()}),a._onSetBg=function(){a.options=a.getAttrVals()},a._onSetFg=function(){a.options=a.getAttrVals()},a._onSetRealtime=function(){a.options=a.getAttrVals()},a._onSetSize=function(){a.options=a.getAttrVals()},a._onSetCursor=function(){a.options=a.getAttrVals()}},render:function(){var a=this,b=Math.ceil(a.$el.innerWidth()),c=Math.ceil(a.$el.innerHeight()),d=window.devicePixelRatio||1;if(a.pixels=b*c,a.$scratchpad.attr("width",b).attr("height",c),a.canvas.setAttribute("width",b*d),a.canvas.setAttribute("height",c*d),a.ctx.scale(d,d),a.pixels=b*d*c*d,a.$img.hide(),a.options.bg&&("#"===a.options.bg.charAt(0)?a.$el.css("backgroundColor",a.options.bg):(a.$el.css("backgroundColor",f),a.$img.attr("src",a.options.bg))),a.options.fg)if("#"===a.options.fg.charAt(0))a.ctx.fillStyle=a.options.fg,a.ctx.beginPath(),a.ctx.rect(0,0,b,c),a.ctx.fill(),a.$img.show();else{var e=new Image;e.onload=function(){a.ctx.drawImage(this,0,0,b,c),a.$img.show()},a.options.fgOrigin&&(e.crossOrigin="*"),e.src=a.options.fg}a.options.cursor&&"crosshair"!==a.options.cursor&&a._setCursor()},clear:function(){var a=this;a.ctx.clearRect(0,0,Math.ceil(a.$el.innerWidth()),Math.ceil(a.$el.innerHeight()))},enable:function(a){this.enabled=a===!0?!0:!1},_bindEvents:function(){var a=this;a.$scratchpad.on(h.start,function(b){return a.enabled?(a.canvasOffset=a.$scratchpad.offset(),a.scratch=!0,void a._scratchFunc(b,"Down")):!0}).on(h.move,function(b){b.preventDefault(),a.scratch&&a._scratchFunc(b,"Move")}).on(h.end,function(b){b.preventDefault(),a.scratch&&(a.scratch=!1,a._scratchFunc(b,"Up"))})},_setCursor:function(){var a=this;a.$el.css("cursor",a.options.cursor)},_scratchFunc:function(a,b){var c=this;a.pageX=Math.floor(a.pageX-c.canvasOffset.left),a.pageY=Math.floor(a.pageY-c.canvasOffset.top),c["_scratch"+b](a)},_scratchDown:function(a){var b=this;b.ctx.globalCompositeOperation="destination-out",this.ctx.lineJoin="round",b.ctx.lineCap="round",b.ctx.strokeStyle=this.options.color,b.ctx.lineWidth=this.options.size,b.ctx.beginPath(),b.ctx.arc(a.pageX,a.pageY,this.options.size/2,0,2*Math.PI,!0),b.ctx.closePath(),b.ctx.fill(),b.ctx.beginPath(),b.ctx.moveTo(a.pageX,a.pageY),b.fire("down")},_scratchMove:function(a){var b=this;b.ctx.lineTo(a.pageX,a.pageY),b.ctx.stroke(),b.options.realtime&&b._scratchPercent(),b.fire("move")},_scratchUp:function(){var a=this;a.ctx.closePath(),a._scratchPercent(),a.fire("up")},_scratchPercent:function(){for(var a=this,b=0,c=a.ctx.getImageData(0,0,a.canvas.width,a.canvas.height),d=0,e=c.data.length;e>d;d+=4)0===c.data[d]&&0===c.data[d+1]&&0===c.data[d+2]&&0===c.data[d+3]&&b++;a.set("eraser",b/this.pixels*100)},_supportCanvas:function(){return!document.createElement("canvas").getContext}},{ATTRS:{srcNode:{value:f,getter:function(a){return g(a)}},eraser:{value:0},realtime:{value:!1},size:{value:5},bg:{value:"#cacaca"},bgOrigin:{value:!1},bgSize:{value:null},fg:{value:"#6699ff"},fgOrigin:{value:!1},cursor:{value:"crosshair"},color:{value:"#cccccc"}}}),e},{requires:["node","base","event"]});