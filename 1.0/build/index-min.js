/*!build time : 2014-07-21 12:29:52 PM*/
KISSY.add("gallery/wScratchPad/1.0/index",function(a,b,c){"use strict";function d(a){var b=this;return a.srcNode==e?(alert("\u6e32\u67d3\u8282\u70b9\u4e0d\u80fd\u4e3a\u7a7a"),!0):void d.superclass.constructor.call(b,a)}var e="",f=b.all;return a.extend(d,c,{initializer:function(){var a=this;return a.options=a.getAttrVals(),a.$el=a.get("srcNode"),a._supportCanvas()?(a.$el.html("Canvas is not supported in this browser."),!0):(a.enabled=!0,a.canvas=document.createElement("canvas"),a.ctx=a.canvas.getContext("2d"),"static"===a.$el.css("position")&&a.$el.css("position","relative"),a.$img=f('<img src=""/>'),a.options.bgOrigin&&a.$img.attr("crossOrigin","*"),a.$img.css(a.options.bgSize?{position:"absolute",width:a.options.bgSize.width,height:a.options.bgSize.height}:{position:"absolute",width:"100%",height:"100%"}),a.$scratchpad=f(a.canvas).css({position:"absolute",width:"100%",height:"100%"}),a.bindMobileEvents(),a.bindPcEvents(),a.$el.append(a.$img).append(a.$scratchpad),a.render(),void a._addEvent())},_addEvent:function(){var a=this;a.on("destroy",function(){a.$el.children().remove()}),a.on("afterBgChange",function(){a.options=a.getAttrVals(),a.render()}),a.on("afterFgChange",function(){a.options=a.getAttrVals(),a.render()}),a.on("afterRealtimeChange",function(){a.options=a.getAttrVals()}),a.on("afterSizeChange",function(){a.options=a.getAttrVals()}),a.on("afterCursorChange",function(){a.options=a.getAttrVals(),a._setCursor()})},render:function(){var a=this,b=Math.ceil(a.$el.innerWidth()),c=Math.ceil(a.$el.innerHeight()),d=window.devicePixelRatio||1;if(a.pixels=b*c,a.$scratchpad.attr("width",b).attr("height",c),a.canvas.setAttribute("width",b*d),a.canvas.setAttribute("height",c*d),a.ctx.scale(d,d),a.pixels=b*d*c*d,a.$img.hide(),a.options.bg&&("#"===a.options.bg.charAt(0)?a.$el.css("backgroundColor",a.options.bg):(a.$el.css("backgroundColor",e),a.$img.attr("src",a.options.bg))),a.options.fg)if("#"===a.options.fg.charAt(0))a.ctx.fillStyle=a.options.fg,a.ctx.beginPath(),a.ctx.rect(0,0,b,c),a.ctx.fill(),a.$img.show();else{var f=new Image;f.onload=function(){a.ctx.drawImage(this,0,0,b,c),a.$img.show()},a.options.fgOrigin&&(f.crossOrigin="*"),f.src=a.options.fg}a.options.cursor&&"crosshair"!==a.options.cursor&&a._setCursor()},clear:function(){var a=this;a.ctx.clearRect(0,0,Math.ceil(a.$el.innerWidth()),Math.ceil(a.$el.innerHeight()))},enable:function(a){this.enabled=a===!0?!0:!1},bindMobileEvents:function(){var a=this;a.$scratchpad.on("touchstart touchmove touchend touchcancel",function(a){var b=a.changedTouches||a.originalEvent.targetTouches,c=b[0],d=e;switch(a.type){case"touchstart":d="mousedown";break;case"touchmove":d="mousemove",a.preventDefault();break;case"touchend":d="mouseup";break;default:return}var f=document.createEvent("MouseEvent");f.initMouseEvent(d,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null),c.target.dispatchEvent(f)})},bindPcEvents:function(){var a=this;a.$scratchpad.on("mousedown",function(b){return a.enabled?(a.canvasOffset=a.$scratchpad.offset(),a.scratch=!0,void a._scratchFunc(b,"Down")):!0}).on("mousemove",function(b){a.scratch&&a._scratchFunc(b,"Move")}).on("mouseup",function(b){a.scratch&&(a.scratch=!1,a._scratchFunc(b,"Up"))})},_setCursor:function(){var a=this;a.$el.css("cursor",a.options.cursor)},_scratchFunc:function(a,b){var c=this;a.pageX=a.offsetX||Math.floor(a.pageX-c.canvasOffset.left),a.pageY=a.offsetY||Math.floor(a.pageY-c.canvasOffset.top),c["_scratch"+b](a)},_scratchDown:function(a){var b=this;b.ctx.globalCompositeOperation="destination-out",this.ctx.lineJoin="round",b.ctx.lineCap="round",b.ctx.strokeStyle=this.options.color,b.ctx.lineWidth=this.options.size,b.ctx.beginPath(),b.ctx.arc(a.pageX,a.pageY,this.options.size/2,0,2*Math.PI,!0),b.ctx.closePath(),b.ctx.fill(),b.ctx.beginPath(),b.ctx.moveTo(a.pageX,a.pageY),b.fire("down")},_scratchMove:function(a){var b=this;b.ctx.lineTo(a.pageX,a.pageY),b.ctx.stroke(),b.options.realtime&&b._scratchPercent(),b.fire("move")},_scratchUp:function(){var a=this;a.ctx.closePath(),a._scratchPercent(),a.fire("up")},_scratchPercent:function(){for(var a=this,b=0,c=a.ctx.getImageData(0,0,a.canvas.width,a.canvas.height),d=0,e=c.data.length;e>d;d+=4)0===c.data[d]&&0===c.data[d+1]&&0===c.data[d+2]&&0===c.data[d+3]&&b++;a.set("eraser",b/this.pixels*100)},_supportCanvas:function(){return!document.createElement("canvas").getContext}},{ATTRS:{srcNode:{value:e,getter:function(a){return f(a)}},eraser:{value:0},realtime:{value:!1},size:{value:5},bg:{value:"#cacaca"},bgOrigin:{value:!1},bgSize:{value:null},fg:{value:"#6699ff"},fgOrigin:{value:!1},cursor:{value:"crosshair"}}}),d},{requires:["node","base","event"]});